@model IEnumerable<PMMX.Modelo.Entidades.Operaciones.Evento>

@{
    ViewBag.Title = "Index";
    Layout = Request.IsAjaxRequest() ? null : "~/Views/Shared/_Layout.cshtml";
}

    @Styles.Render("~/Style/Bootstrap")
    @Styles.Render("~/Style/Font-Awesome")
    @Styles.Render("~/Style/FullCalendar")
    @Styles.Render("~/Style/Scheduler")
    @Styles.Render("~/Style/AdminLTE")
    @Styles.Render("~/Style/Select2")

<link rel="stylesheet" href="~/bower_components/fullcalendar/dist/fullcalendar.print.min.css" media="print">

<h2>Calendario de Eventos</h2>
<p>
    <i class="fa fa-plus-circle text-green"></i>
    @Html.ActionLink("Create New", "Create")

    <div class="form-group">
        <div class="col-md-6"><select id="slt-Categorias" class="form-control select2"></select></div>
        </br></br>
    </div>
</p>

<div id='calendar' style="width: 70%; height: 70%; max-width: 900px; margin: 0 auto;"></div>

 <!-- Modal-->
<div class="modal fade" id="createAssetModal" role="dialog" aria-labelledby="CreateAssetModal" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header alert-info">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div id="createAssetContainer" class="modal-body"></div>
            <div id="subVista" class="modal-body"></div>
            <input id="IdEventoModal" type="hidden" />
            <input id="IdVentanaEvento" type="hidden" />
        </div>
    </div>
</div>


        @Scripts.Render("~/JS/Moment")
        @Scripts.Render("~/JS/jquery")
        @Scripts.Render("~/JS/FullCalendar")
        @Scripts.Render("~/JS/Scheduler")
        @Scripts.Render("~/JS/Select2")

        <script>
            $(document).ready(function ()
            {
                $('.select2').select2();

                GetEvents(formatDate(new Date()), "/Evento/GetEvents?date=" + formatDate(new Date()));
                getCategorias();

                function formatDate(date) {
                    var d = new Date(date),
                        month = '' + (d.getMonth() + 1),
                        //day = '' + d.getDate(),
                        day = '01',
                        year = d.getFullYear();

                    if (month.length < 2) month = '0' + month;
                    if (day.length < 2) day = '0' + day;

                    return [year, month, day].join('-');
                }

                function formatCurrentDate(date) {
                    var d = new Date(date),
                        month = '' + (d.getMonth() + 1),
                        day = '' + d.getDate(),
                        year = d.getFullYear();

                    if (month.length < 2) month = '0' + month;
                    if (day.length < 2) day = '0' + day;

                    return [year, month, day].join('-');
                }

                $('#calendar').on('click', '.fc-next-button, .fc-prev-button', function () {
                    var view = $('#calendar').fullCalendar('getView');

                    switch (view.name)
                    {
                        case "month":
                            var date = $.fullCalendar.formatDate($('#calendar').fullCalendar('getDate'), "YYYY-MM-DD");
                            var url = "/Evento/GetEvents?date=" + date;
                            GetEvents(date, url);
                            break;
                        case "timelineWeek":
                            var d = new Date($('#calendar').fullCalendar('getDate'));
                            var date = formatCurrentDate(d.setDate(d.getDate() + 7));
                            
                            $('#calendar').fullCalendar('gotoDate', date);
                            $('#calendar').fullCalendar('changeView', view.name);
                            break;
                        case "timelineDay": 
                            var d = new Date($('#calendar').fullCalendar('getDate'));
                            var date = formatCurrentDate(d.setDate(d.getDate() + 1));
                            
                            $('#calendar').fullCalendar('gotoDate', date);
                            $('#calendar').fullCalendar('changeView', view.name);
                            break;
                    }                   
                });
                
               $('#calendar').on('click', '.fc-basicWeek-button', function () {
                   var date = formatCurrentDate(new Date());

                    $('#calendar').fullCalendar('gotoDate', date);
                    $('#calendar').fullCalendar('changeView', 'timelineWeek');
                });

                $('#calendar').on('click', '.fc-basicDay-button', function () {
                    var date = formatCurrentDate(new Date());

                    $('#calendar').fullCalendar('gotoDate', date);
                    $('#calendar').fullCalendar('changeView', 'timelineDay');
                });
                
                function GetEvents(date, url)
                {
                    $.ajax({
                        dataType: "json",
                        contentType: "application/json",
                        data: "{}",
                        url: url,
                        dataType: "json",
                        success: function (data) {
                            $('#calendar').fullCalendar('destroy');
                            $('#calendar').fullCalendar('render');

                            $('#calendar').fullCalendar({
                                schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
                                theme: false,
                                header: {
                                    left: 'prev,next today',
                                    center: 'title',
                                    right: 'month,basicWeek,basicDay'
                                },
                                defaultView: 'month',
                                editable: false,
                                lang: 'es',
                                eventLimit: 15,
                                eventLimitText: 'More',
                                weekMode: 'liquid',
                                displayEventTime: false,
                                slotEventOverlap: false,
                                nowIndicator: true,
                                resources: [
                                    {
                                        id: '15',
                                        title: 'Impo',
                                        children: [
                                            {
                                                id: 'Importacion-Mañana',
                                                title: 'Mañana'
                                            },
                                            {
                                                id: 'Importacion-Tarde',
                                                title: 'Tarde'
                                            }
                                        ]
                                    },
                                    {
                                        id: '16',
                                        title: 'Expo',
                                        children: [
                                            {
                                                id: 'Exportacion-Mañana',
                                                title: 'Mañana'
                                            },
                                            {
                                                id: 'Exportacion-Tarde',
                                                title: 'Tarde'
                                            }
                                        ]
                                    },
                                    {
                                        id: '17',
                                        title: 'Local',
                                        children: [
                                            {
                                                id: 'Local-Mañana',
                                                title: 'Mañana'
                                            },
                                            {
                                                id: 'Local-Tarde',
                                                title: 'Tarde'
                                            }
                                        ]
                                    },
                                    {
                                        id: '18',
                                        title: 'Tab expandido',
                                        children: [
                                            {
                                                id: 'Tab expandido-Mañana',
                                                title: 'Mañana'
                                            },
                                            {
                                                id: 'Tab expandido-Tarde',
                                                title: 'Tarde'
                                            }
                                        ]
                                    },
                                    {
                                        id: 'd',
                                        title: 'Sin Datos'
                                    },

                                ],
                                events: $.map(data.events, function (item, i) {
                                    var event = new Object();
                                    event.start = moment(item.FechaInicio).utc();
                                    event.end = moment(item.FechaFin).utc();
                                    event.title = item.Descripcion;
                                    event.brief = item.Nota;
                                    event.id = item.Id;
                                    event.color = item.Color;
                                    event.resourceId = item.Clasificacion;
                                    return event;
                                }),
                                eventClick: function (calEvent, jsEvent, view) {
                                    var url = "/Operaciones/Evento/Details/" + calEvent.id;

                                    $.get(url, function (data) {
                                        $('#createAssetContainer').html(data);
                                        $('#createAssetModal').modal('show');
                                        $('#IdEventoModal').val(calEvent.id);
                                    });
                                }
                            });

                            $('#calendar').fullCalendar('gotoDate', date);
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            alert('There was an error while fetching events!');
                        }
                    });
                }

                function getCategorias() {
                    $.ajax({
                        dataType: "json",
                        contentType: "application/json",
                        url: "/Operaciones/Categoria/GetCategorias",
                        success: function (data) {
                            items = '<option>Categoria</option>';
                            $.each(data.lista, function (i, k) {
                                items += "<option value='" + k.Id + "'>" + k.Nombre + "</option>";
                            });
                            $('#slt-Categorias').html(items);
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            alert('There was an error while fetching data!');
                        }
                    });
                }

                $('#slt-Categorias').on("change", function ()
                {
                    var date = $.fullCalendar.formatDate($('#calendar').fullCalendar('getDate'), "YYYY-MM-DD");
                    var url = "/Evento/GetEvents?date=" + date;

                    if ($('#slt-Categorias').val() == "Categoria")
                        GetEvents(date, url);
                    else
                    {
                        url = "/Evento/GetEventsByCategoria?IdCategoria=" + $('#slt-Categorias').val() + "&Date=" + date,
                        GetEvents(date, url);
                    }
                });
                
            });

        </script>
    
